@startuml
title 사용자 인증 활동 다이어그램

|#LightBlue|일반 로그인|
start

:로그인 요청 수신;
note right: 이메일, 비밀번호

:입력값 검증;

if (필수 필드 존재?) then (아니오)
  :400 Bad Request 응답;
  stop
endif

:이메일로 사용자 조회;

if (사용자 존재?) then (아니오)
  :401 Invalid Credentials 응답;
  stop
endif

:계정 상태 검증;

if (계정 정지?) then (예)
  :403 Account Suspended 응답;
  stop
elseif (이메일 미인증?) then (예)
  :403 Email Not Verified 응답;
  stop
endif

:로그인 시도 횟수 확인;

if (시도 횟수 초과?) then (예)
  :429 Too Many Attempts 응답;
  stop
endif

:비밀번호 검증;

if (비밀번호 일치?) then (아니오)
  :실패 시도 횟수 증가;
  :401 Invalid Credentials 응답;
  stop
endif

:JWT 토큰 생성;
note right: Access Token + Refresh Token

:사용자 세션 저장;
:실패 시도 횟수 초기화;
:마지막 로그인 시간 업데이트;
:로그인 감사 로그 기록;

:200 로그인 성공 응답;

|#LightGreen|소셜 로그인|
:소셜 로그인 요청 수신;
note right: Provider, OAuth Token

:OAuth 토큰 검증;

if (유효한 토큰?) then (아니오)
  :401 Invalid OAuth Token 응답;
  stop
endif

:OAuth 사용자 정보 획득;

:이메일로 기존 사용자 확인;

if (기존 사용자 존재?) then (아니오)
  :OAuth 정보로 신규 사용자 생성;
  :소셜 가입 환영 알림 발송;
else (예)
  :OAuth 계정 연동 정보 업데이트;
endif

:JWT 토큰 생성;
:사용자 세션 저장;
:소셜 로그인 감사 로그 기록;

:200 소셜 로그인 성공 응답;

|#LightYellow|토큰 갱신|
:토큰 갱신 요청 수신;
note right: Refresh Token

:리프레시 토큰 검증;

if (유효한 토큰?) then (아니오)
  :401 Invalid Token 응답;
  stop
endif

:사용자 세션 확인;

if (세션 존재?) then (아니오)
  :401 Session Expired 응답;
  stop
endif

:새 Access Token 생성;

:200 토큰 갱신 응답;

|#LightCoral|로그아웃|
:로그아웃 요청 수신;

:사용자 세션 무효화;
:리프레시 토큰 블랙리스트 등록;
:로그아웃 감사 로그 기록;

:200 로그아웃 성공 응답;

stop

@enduml
